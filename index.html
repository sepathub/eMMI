<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-Rekod MMI SK Simpang Empat</title>
    
    <!-- Memuatkan Tailwind CSS untuk gaya -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuatkan Font (Optional: Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Konfigurasi Font Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Memuatkan Babel untuk memproses kod React dalam browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Pengubahsuaian scrollbar supaya nampak kemas */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* GAYA CETAKAN KHAS */
        @media print {
            @page {
                size: A4 landscape; /* Cetak melintang untuk muat jadual */
                margin: 0.5cm;
            }
            body {
                background: white;
                -webkit-print-color-adjust: exact; /* Pastikan warna background keluar */
                print-color-adjust: exact;
                font-family: sans-serif;
            }
            /* Sembunyikan semua elemen yang tidak perlu */
            .no-print, header, footer, .tabs-nav, .admin-btn {
                display: none !important;
            }
            /* Paparkan bahagian laporan sahaja */
            #printable-report {
                display: block !important;
                visibility: visible !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }
            
            /* Gaya Jadual Cetakan */
            .print-page-break {
                page-break-after: always;
                margin-bottom: 20px;
                height: 100vh; /* Paksa satu halaman penuh jika boleh */
                display: flex;
                flex-direction: column;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 9pt; /* Font kecil sikit untuk muat 12 masa */
                table-layout: fixed; /* Tetapkan lebar lajur sama rata */
            }
            th, td {
                border: 1px solid black !important;
                padding: 4px;
                text-align: center;
                vertical-align: middle;
                overflow: hidden;
            }
            th {
                background-color: #f3f4f6 !important;
                font-weight: bold;
                height: 30px;
            }
            td {
                height: 60px; /* Tinggi sel tetap untuk kekemasan */
            }
            /* Lajur pertama (Hari) */
            th:first-child, td:first-child {
                width: 100px;
                background-color: #f9fafb !important;
                font-weight: bold;
            }
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <!-- Skrip Utama Aplikasi -->
    <script type="text/babel" data-type="module">
        // Import React & Libraries
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { motion, AnimatePresence } from 'https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0,react-dom@18.2.0';
        import { 
            BookOpen, User, Clock, ClipboardList, CheckCircle, Calendar, 
            ChevronDown, Trash2, Timer, BarChart3, CalendarDays, Search, X, 
            Users, School, Lock, ShieldCheck, PlusCircle, Printer, LogOut, LogIn
        } from 'https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0,react-dom@18.2.0';
        
        // --- 1. IMPORT SUPABASE ---
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        function App() {
            // --- 2. KONFIGURASI SUPABASE ---
            const supabaseUrl = 'https://dmordrhbqoscisyfxvie.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtb3JkcmhicW9zY2lzeWZ4dmllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNzE0MjcsImV4cCI6MjA4Mjc0NzQyN30.IneYIzHI3aBMF_XhLvO7WIjlZaWs9w06HBIrZdktYZE';
            const supabase = createClient(supabaseUrl, supabaseKey);

            // State untuk navigasi dan data
            const [activeTab, setActiveTab] = useState('entry'); // 'entry', 'report', 'weekly', 'admin'
            
            // State records
            const [records, setRecords] = useState([]);

            const [notification, setNotification] = useState(null);
            const [searchTerm, setSearchTerm] = useState(''); // State untuk carian

            // ADMIN STATES
            const [isAdmin, setIsAdmin] = useState(false);
            const [adminPass, setAdminPass] = useState('');
            const [adminDate, setAdminDate] = useState(new Date().toISOString().split('T')[0]); // Default hari ini
            
            // STATE UNTUK LAPORAN MINGGUAN ADMIN
            const [adminReportWeek, setAdminReportWeek] = useState(1); 
            const [adminReportClass, setAdminReportClass] = useState('all'); // 'all' atau nama kelas

            // --- 3. TARIK DATA DARI SUPABASE ---
            useEffect(() => {
                fetchRecords();
            }, []);

            const fetchRecords = async () => {
                const { data, error } = await supabase
                    .from('rekod_mmi')
                    .select('*')
                    .order('id', { ascending: false });

                if (error) {
                    console.error('Error fetching records:', error);
                } else {
                    const formattedData = (data || []).map(item => ({
                        id: item.id,
                        teacherName: item.teachername || item.teacherName,
                        className: item.classname || item.className,
                        subject: item.subject,
                        period: item.period,
                        timestamp: item.timestamp,
                        date: item.date
                    }));
                    setRecords(formattedData);
                }
            };

            // Data Senarai Kelas
            const KELAS_LIST = [
                "PRA Cemerlang", "Pra Gemilang",
                "1 Ikhlas", "1 Setia",
                "2 Maju", "2 Perkasa",
                "3 Naim", "3 Aktif",
                "4 Gigih", "4 Ehsan",
                "5 Mahir", "5 Pintar",
                "6 Arif", "6 Tekun",
                "PPKI Adn", "PPKI Mawa", "PPKI Firdaus", "PPKI Rayyan"
            ];

            // Data Senarai Subjek
            const SUBJEK_LIST = [
                "Bahasa Melayu (BM)", "Bahasa Inggeris (BI)", "Matematik (MT)", "Sains (SN)",
                "Bahasa Arab (BA)", "Pendidikan Islam (PAI)", "Pendidikan Moral", 
                "Pendidikan Jasmani & Kesihatan (PJK)",
                "Pendidikan Seni Visual (PSV)", "Pendidikan Muzik", "Sejarah (SEJ)",
                "Reka Bentuk & Teknologi (RBT)", "TASMIK", "Kelas Ganti",
                "Lain-lain"
            ];

            // Data Senarai Masa
            const MASA_LIST = Array.from({ length: 12 }, (_, i) => i + 1);

            // --- LOGIK MINGGUAN ---
            const generateWeeks2026 = () => {
                const weeks = [];
                let currentDate = new Date(2026, 0, 5); 
                
                for (let i = 1; i <= 52; i++) {
                    const startDate = new Date(currentDate);
                    startDate.setHours(0,0,0,0);
                    
                    const endDate = new Date(currentDate);
                    endDate.setDate(currentDate.getDate() + 4); 
                    endDate.setHours(23,59,59,999);

                    const format = (d) => `${d.getDate()}/${d.getMonth() + 1}`;
                    
                    weeks.push({
                        id: i,
                        label: `Minggu ${i}`,
                        range: `${format(startDate)} - ${format(endDate)}`,
                        startObj: startDate,
                        endObj: endDate
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 7);
                }
                return weeks;
            };

            const WEEKS_LIST = generateWeeks2026();

            const getCurrentWeekId = () => {
                const today = new Date();
                const foundWeek = WEEKS_LIST.find(week => 
                    today >= week.startObj && today <= new Date(week.endObj.getTime() + 2 * 86400000) 
                );
                return foundWeek ? foundWeek.id : WEEKS_LIST[0].id;
            };

            const [selectedWeek, setSelectedWeek] = useState(getCurrentWeekId());

            useEffect(() => {
                setAdminReportWeek(getCurrentWeekId());
            }, []);

            // State Borang
            const [formData, setFormData] = useState({
                teacherName: '',
                selectedClass: '',
                selectedSubject: '',
                selectedPeriod: ''
            });

            // State Borang Admin
            const [adminFormData, setAdminFormData] = useState({
                teacherName: '',
                selectedClass: '',
                selectedSubject: '',
                selectedPeriod: ''
            });

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleAdminInputChange = (e) => {
                const { name, value } = e.target;
                setAdminFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleAdminLogin = (e) => {
                e.preventDefault();
                if (adminPass === 'Sayacomel123') {
                    setIsAdmin(true);
                    showNotification("Berjaya log masuk admin", "success");
                } else {
                    showNotification("Kata laluan salah", "error");
                }
            };

            const handleAdminLogout = () => {
                setIsAdmin(false);
                setAdminPass('');
                setActiveTab('entry'); 
                showNotification("Berjaya log keluar", "success");
            };

            const handleDelete = async (id) => {
                if (window.confirm("Adakah anda pasti mahu memadam rekod ini?")) {
                    const { error } = await supabase.from('rekod_mmi').delete().eq('id', id);
                    if (error) {
                        showNotification("Gagal memadam rekod.", "error");
                    } else {
                        fetchRecords();
                        showNotification("Rekod telah dipadam.", "success");
                    }
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.teacherName || !formData.selectedClass || !formData.selectedSubject || !formData.selectedPeriod) {
                    showNotification("Sila lengkapkan semua maklumat!", "error");
                    return;
                }
                const newRecordPayload = {
                    teachername: formData.teacherName,
                    classname: formData.selectedClass,
                    subject: formData.selectedSubject,
                    period: formData.selectedPeriod,
                    timestamp: new Date().toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' }),
                    date: new Date().toLocaleDateString('ms-MY')
                };
                const { error } = await supabase.from('rekod_mmi').insert([newRecordPayload]);
                if (error) {
                    showNotification("Gagal menyimpan.", "error");
                } else {
                    fetchRecords(); 
                    setFormData({ teacherName: '', selectedClass: '', selectedSubject: '', selectedPeriod: '' });
                    showNotification("Rekod berjaya disimpan online!", "success");
                }
            };

            const handleAdminSubmit = async (e) => {
                e.preventDefault();
                if (!adminFormData.teacherName || !adminFormData.selectedClass || !adminFormData.selectedSubject || !adminFormData.selectedPeriod) {
                    showNotification("Sila lengkapkan semua maklumat!", "error");
                    return;
                }
                const dateObj = new Date(adminDate);
                const formattedDate = dateObj.toLocaleDateString('ms-MY');
                const newRecordPayload = {
                    teachername: adminFormData.teacherName,
                    classname: adminFormData.selectedClass,
                    subject: adminFormData.selectedSubject,
                    period: adminFormData.selectedPeriod,
                    timestamp: "MANUAL",
                    date: formattedDate
                };
                const { error } = await supabase.from('rekod_mmi').insert([newRecordPayload]);
                if (error) {
                    showNotification("Gagal menyimpan.", "error");
                } else {
                    fetchRecords(); 
                    setAdminFormData({ teacherName: '', selectedClass: '', selectedSubject: '', selectedPeriod: '' });
                    showNotification(`Rekod ditambah untuk tarikh ${formattedDate}`, "success");
                }
            };

            const showNotification = (message, type) => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const handlePrint = () => {
                window.print();
            };

            // --- FUNGSI JANA DATA JADUAL ---
            const getTableDataForClass = (targetClass) => {
                const weekData = WEEKS_LIST.find(w => w.id === adminReportWeek);
                if (!weekData) return null;

                const days = [];
                for (let i = 0; i < 5; i++) {
                    const d = new Date(weekData.startObj);
                    d.setDate(d.getDate() + i);
                    days.push(d.toLocaleDateString('ms-MY'));
                }

                return {
                    className: targetClass,
                    weekLabel: weekData.label,
                    range: weekData.range,
                    days: days
                };
            };

            // Helper untuk cari guru dalam sel jadual
            const getTeacherForCell = (dateStr, periodStr, className) => {
                // Cari rekod yang sepadan
                // periodStr perlu match dengan apa yang disimpan (biasanya string "1", "2")
                const record = records.find(r => 
                    r.date === dateStr && 
                    r.className === className && 
                    r.period.toString() === periodStr.toString()
                );
                return record;
            };

            // Tentukan kelas mana nak dicetak
            const classesToPrint = adminReportClass === 'all' 
                ? KELAS_LIST 
                : [adminReportClass];

            const getClassStats = () => {
                const stats = {};
                const currentWeekData = WEEKS_LIST.find(w => w.id === selectedWeek);
                if (!currentWeekData) return [];

                records.forEach(record => {
                    if (!record.date) return;
                    const [day, month, year] = record.date.split('/').map(Number);
                    const recordDate = new Date(year, month - 1, day); 
                    const weekStart = currentWeekData.startObj;
                    const weekEnd = new Date(currentWeekData.endObj);
                    weekEnd.setDate(weekEnd.getDate() + 2); 
                    weekEnd.setHours(23,59,59,999);

                    if (recordDate >= weekStart && recordDate <= weekEnd) {
                        if (!stats[record.className]) {
                            stats[record.className] = { name: record.className, totalEntries: 0 };
                        }
                        stats[record.className].totalEntries += 1;
                    }
                });
                return Object.values(stats).sort((a, b) => a.name.localeCompare(b.name));
            };

            const getFilteredRecords = () => {
                const today = new Date().toLocaleDateString('ms-MY');
                let filtered = records.filter(record => record.date === today);
                if (!searchTerm) return filtered;
                const lowerTerm = searchTerm.toLowerCase();
                return filtered.filter(record => 
                    (record.teacherName || '').toLowerCase().includes(lowerTerm) ||
                    (record.className || '').toLowerCase().includes(lowerTerm) ||
                    (record.subject || '').toLowerCase().includes(lowerTerm)
                );
            };

            const getAdminFilteredRecords = () => {
                const selectedDateObj = new Date(adminDate);
                const formattedSelectDate = selectedDateObj.toLocaleDateString('ms-MY');
                return records.filter(record => record.date === formattedSelectDate);
            };

            const displayedRecords = getFilteredRecords();
            const adminRecords = getAdminFilteredRecords();

            const NotificationBanner = () => {
                return (
                <AnimatePresence>
                    {notification && (
                    <motion.div 
                        initial={{ opacity: 0, y: -50, x: "-50%" }}
                        animate={{ opacity: 1, y: 0, x: "-50%" }}
                        exit={{ opacity: 0, y: -50, x: "-50%" }}
                        transition={{ type: "spring", stiffness: 500, damping: 30 }}
                        className={`fixed top-4 left-1/2 px-6 py-3 rounded-full shadow-xl z-50 text-white font-bold flex items-center gap-2 ${notification.type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'}`}
                    >
                        {notification.type === 'success' ? <CheckCircle size={18} /> : <X size={18} />}
                        {notification.message}
                    </motion.div>
                    )}
                </AnimatePresence>
                );
            };

            const tabVariants = {
                hidden: { opacity: 0, x: -10 },
                visible: { opacity: 1, x: 0, transition: { duration: 0.3, ease: "easeOut" } },
                exit: { opacity: 0, x: 10, transition: { duration: 0.2, ease: "easeIn" } }
            };

            const containerVariants = {
                hidden: { opacity: 0 },
                visible: { opacity: 1, transition: { staggerChildren: 0.1 } }
            };

            const itemVariants = {
                hidden: { opacity: 0, y: 20 },
                visible: { opacity: 1, y: 0 }
            };

            return (
                <div className="min-h-screen bg-slate-100 font-sans pb-24 selection:bg-indigo-200">
                <NotificationBanner />

                <header className="no-print bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 text-white p-8 rounded-b-[3rem] shadow-xl mb-8 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                        <motion.div animate={{ rotate: 360 }} transition={{ duration: 50, repeat: Infinity, ease: "linear" }} className="absolute top-[-50px] left-[-50px] w-40 h-40 bg-white rounded-full mix-blend-overlay blur-3xl"/>
                        <motion.div animate={{ rotate: -360 }} transition={{ duration: 60, repeat: Infinity, ease: "linear" }} className="absolute bottom-[-50px] right-[-50px] w-60 h-60 bg-yellow-300 rounded-full mix-blend-overlay blur-3xl"/>
                    </div>
                    
                    {/* BUTANG ADMIN DI ATAS KANAN */}
                    <button 
                        onClick={() => setActiveTab('admin')} 
                        className="admin-btn absolute top-6 right-6 text-white/70 hover:text-white hover:bg-white/10 p-2 rounded-full transition-all z-20"
                        title="Akses Admin"
                    >
                        <Lock size={20} />
                    </button>

                    <motion.div initial={{ scale: 0.8, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} transition={{ duration: 0.5, type: "spring" }} className="relative z-10 flex flex-col items-center text-center">
                    <motion.div whileHover={{ scale: 1.1, rotate: 5 }} className="bg-white p-2 rounded-full shadow-lg mb-4">
                        <img src="https://i.postimg.cc/W4vLfYrm/LOGO-SKSE-utk-background-putih-(2).jpg" alt="Logo SKSE" className="w-24 h-24 object-contain rounded-full"/>
                    </motion.div>
                    <h1 className="text-xs font-bold tracking-[0.2em] text-indigo-100 uppercase mb-2 bg-indigo-800 bg-opacity-30 px-4 py-1 rounded-full">Sistem e-Rekod MMI</h1>
                    <h2 className="text-3xl font-extrabold leading-tight text-white drop-shadow-md">SK SIMPANG EMPAT</h2>
                    <p className="text-indigo-100 text-sm mt-3 flex items-center gap-2 bg-white/10 px-4 py-1.5 rounded-full backdrop-blur-sm">
                        <Calendar size={14} className="text-yellow-300" /> 
                        {new Date().toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                    </p>
                    </motion.div>
                </header>

                <main className="px-4 max-w-lg mx-auto">
                    
                    <div className="tabs-nav no-print flex justify-between bg-white p-1.5 rounded-2xl shadow-lg shadow-indigo-100 mb-8 mx-2 overflow-x-auto">
                    {[
                        { id: 'entry', icon: User, label: 'Masuk', color: 'bg-indigo-500' },
                        { id: 'report', icon: ClipboardList, label: 'Harian', color: 'bg-rose-500' },
                        { id: 'weekly', icon: BarChart3, label: 'Mingguan', color: 'bg-amber-500' },
                        // ADMIN TAB TELAH DIBUANG DARI SINI
                    ].map((tab) => (
                        <button 
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex-1 py-3 px-2 rounded-xl text-xs sm:text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 relative min-w-[80px] ${activeTab === tab.id ? `text-white shadow-md transform scale-105` : 'text-slate-400 hover:bg-slate-50 hover:text-slate-600'}`}
                        >
                            {activeTab === tab.id && (
                            <motion.div layoutId="activeTab" className={`absolute inset-0 rounded-xl ${tab.color}`} initial={false} transition={{ type: "spring", stiffness: 500, damping: 30 }}/>
                            )}
                            <span className="relative z-10 flex items-center gap-1 sm:gap-2">
                            <tab.icon size={16} /> <span className="hidden sm:inline">{tab.label}</span>
                            </span>
                        </button>
                    ))}
                    </div>

                    <AnimatePresence mode="wait">
                    
                    {activeTab === 'entry' && (
                    <motion.div key="entry" variants={tabVariants} initial="hidden" animate="visible" exit="exit" className="space-y-5">
                        <motion.div variants={itemVariants} initial="hidden" animate="visible" transition={{ delay: 0.1 }} className="bg-white p-1 rounded-2xl shadow-sm border-b-4 border-indigo-100 focus-within:border-indigo-400 transition-colors">
                        <div className="p-5">
                            <label className="text-xs font-bold text-indigo-400 uppercase tracking-wide mb-2 block">Nama Penuh</label>
                            <div className="flex items-center gap-3">
                                <div className="bg-indigo-50 p-2.5 rounded-xl text-indigo-500"><User size={22} /></div>
                                <input type="text" name="teacherName" value={formData.teacherName} onChange={handleInputChange} placeholder="Cikgu..." className="w-full bg-transparent font-bold text-slate-700 text-lg focus:outline-none placeholder-slate-300"/>
                            </div>
                        </div>
                        </motion.div>

                        <motion.div variants={itemVariants} initial="hidden" animate="visible" transition={{ delay: 0.2 }} className="bg-white p-1 rounded-2xl shadow-sm border-b-4 border-teal-100 focus-within:border-teal-400 transition-colors">
                        <div className="p-5">
                            <label className="text-xs font-bold text-teal-400 uppercase tracking-wide mb-2 block">Kelas</label>
                            <div className="relative flex items-center gap-3">
                                <div className="bg-teal-50 p-2.5 rounded-xl text-teal-500"><CheckCircle size={22} /></div>
                                <select name="selectedClass" value={formData.selectedClass} onChange={handleInputChange} className="w-full bg-transparent font-bold text-slate-700 text-lg appearance-none focus:outline-none">
                                <option value="">Pilih Kelas</option>
                                {KELAS_LIST.map((kelas) => (<option key={kelas} value={kelas}>{kelas}</option>))}
                                </select>
                                <ChevronDown className="absolute right-0 text-slate-300 pointer-events-none" size={20} />
                            </div>
                        </div>
                        </motion.div>

                        <motion.div variants={itemVariants} initial="hidden" animate="visible" transition={{ delay: 0.3 }} className="grid grid-cols-5 gap-4">
                            <div className="col-span-2 bg-white p-1 rounded-2xl shadow-sm border-b-4 border-amber-100 focus-within:border-amber-400 transition-colors">
                                <div className="p-4 flex flex-col items-center">
                                    <label className="text-[10px] font-bold text-amber-400 uppercase tracking-wide mb-1 block text-center">Masa</label>
                                    <div className="relative w-full">
                                        <select name="selectedPeriod" value={formData.selectedPeriod} onChange={handleInputChange} className="w-full text-center bg-transparent font-black text-slate-700 text-2xl appearance-none focus:outline-none py-1">
                                            <option value="">-</option>
                                            {MASA_LIST.map((masa) => (<option key={masa} value={masa}>{masa}</option>))}
                                        </select>
                                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none text-slate-200 opacity-20"><Timer size={40} /></div>
                                    </div>
                                </div>
                            </div>
                            <div className="col-span-3 bg-white p-1 rounded-2xl shadow-sm border-b-4 border-rose-100 focus-within:border-rose-400 transition-colors">
                                <div className="p-4">
                                    <label className="text-[10px] font-bold text-rose-400 uppercase tracking-wide mb-2 block">Subjek</label>
                                    <div className="relative">
                                        <select name="selectedSubject" value={formData.selectedSubject} onChange={handleInputChange} className="w-full bg-transparent font-bold text-slate-700 text-lg appearance-none focus:outline-none truncate pr-6">
                                            <option value="">Pilih...</option>
                                            {SUBJEK_LIST.map((subjek) => (<option key={subjek} value={subjek}>{subjek}</option>))}
                                        </select>
                                        <ChevronDown className="absolute right-0 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none" size={20} />
                                    </div>
                                </div>
                            </div>
                        </motion.div>

                        <motion.button initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.4 }} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.95 }} onClick={handleSubmit} className="group w-full mt-6 py-4 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-2xl shadow-xl shadow-indigo-200 font-bold text-lg flex items-center justify-center gap-3 border-b-4 border-indigo-700 active:border-b-0 active:translate-y-1">
                        <div className="bg-white/20 p-1.5 rounded-full group-hover:rotate-12 transition-transform"><CheckCircle size={20} className="text-white" /></div>Sahkan Kehadiran</motion.button>
                    </motion.div>
                    )}

                    {activeTab === 'report' && (
                    <motion.div key="report" variants={tabVariants} initial="hidden" animate="visible" exit="exit" className="space-y-6">
                        <div className="bg-rose-50 p-4 rounded-2xl border border-rose-100 flex justify-between items-center">
                            <div>
                                <h3 className="text-lg font-bold text-rose-800">Laporan Harian</h3>
                                <p className="text-xs text-rose-500">Tarikh: {new Date().toLocaleDateString('ms-MY', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                            </div>
                            <motion.span key={displayedRecords.length} initial={{ scale: 1.5, color: '#e11d48' }} animate={{ scale: 1, color: '#e11d48' }} className="bg-white text-rose-600 shadow-sm border border-rose-100 text-xl font-black px-4 py-2 rounded-xl">{displayedRecords.length}</motion.span>
                        </div>
                        <div className="relative">
                        <input type="text" placeholder="Cari guru, kelas, atau subjek..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-4 pl-12 pr-10 bg-white border border-slate-200 rounded-2xl shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-400 focus:border-transparent text-slate-700 placeholder-slate-400 font-medium transition-all"/>
                        <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"><Search size={20} /></div>
                        {searchTerm && (<button onClick={() => setSearchTerm('')} className="absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-rose-500 transition-colors"><X size={20} /></button>)}
                        </div>
                        {displayedRecords.length === 0 ? (
                        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="text-center py-16 px-6 bg-white rounded-3xl border-2 border-dashed border-slate-200 opacity-70">
                            <div className="inline-block p-4 bg-slate-50 rounded-full mb-3 text-slate-300"><ClipboardList size={40} /></div>
                            <p className="text-slate-400 font-medium">{searchTerm ? "Tiada rekod ditemui untuk carian ini." : "Belum ada guru masuk kelas hari ini."}</p>
                        </motion.div>
                        ) : (
                        <motion.div variants={containerVariants} initial="hidden" animate="visible" className="space-y-4">
                            {KELAS_LIST.map(kelas => {
                                const classRecords = displayedRecords.filter(r => r.className === kelas);
                                if (classRecords.length === 0) return null;
                                return (
                                <motion.div key={kelas} variants={itemVariants} layout className="bg-white rounded-2xl shadow-md shadow-slate-200 overflow-hidden border border-slate-100">
                                    <div className="bg-slate-50/50 px-5 py-3 border-b border-slate-100 flex justify-between items-center">
                                    <h4 className="font-bold text-slate-700 flex items-center gap-2"><span className="w-3 h-3 bg-teal-400 rounded-full shadow-sm shadow-teal-200 block"></span>{kelas}</h4>
                                    </div>
                                    <div className="divide-y divide-slate-50">
                                    <AnimatePresence>
                                    {classRecords.map((record, idx) => (
                                        <motion.div key={record.id} layout initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }} exit={{ opacity: 0, height: 0, transition: { duration: 0.2 } }} className="p-4 flex items-center justify-between hover:bg-indigo-50/30 transition-colors group">
                                        <div className="flex items-center gap-4">
                                            <div className="flex flex-col items-center justify-center w-12 h-12 bg-indigo-100 rounded-xl text-indigo-600 border border-indigo-200">
                                                <span className="text-[9px] font-bold uppercase tracking-wider text-indigo-400">Masa</span>
                                                <span className="text-xl font-black leading-none">{record.period}</span>
                                            </div>
                                            <div>
                                                <p className="font-bold text-slate-700 text-sm">{record.teacherName}</p>
                                                <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide mt-1 ${record.subject === 'Kelas Ganti' ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}`}>{record.subject}</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div className="text-right hidden sm:block">
                                                <span className="text-slate-300 text-[10px] flex items-center justify-end gap-1 bg-slate-100 px-2 py-1 rounded-md"><Clock size={10} /> {record.timestamp}</span>
                                            </div>
                                            <motion.button whileHover={{ scale: 1.1, color: "#ef4444" }} whileTap={{ scale: 0.9 }} onClick={() => handleDelete(record.id)} className="w-8 h-8 flex items-center justify-center text-slate-300 hover:bg-red-50 rounded-full transition-all"><Trash2 size={16} /></motion.button>
                                        </div>
                                        </motion.div>
                                    ))}
                                    </AnimatePresence>
                                    </div>
                                </motion.div>
                                );
                            })}
                        </motion.div>
                        )}
                    </motion.div>
                    )}

                    {activeTab === 'weekly' && (
                    <motion.div key="weekly" variants={tabVariants} initial="hidden" animate="visible" exit="exit" className="space-y-6">
                        <div className="bg-amber-50 p-6 rounded-3xl border border-amber-100 text-center relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-24 h-24 bg-amber-100 rounded-full -mr-8 -mt-8 opacity-50"></div>
                            <div className="relative z-10"><h3 className="text-xl font-bold text-amber-800">Analisis MMI 2026</h3><p className="text-xs text-amber-600 mt-1">Laporan Mengikut Kelas</p></div>
                        </div>
                        <div className="bg-white p-2 rounded-2xl shadow-sm border border-amber-100">
                            <div className="flex items-center gap-2 p-2 bg-amber-50 rounded-xl"><CalendarDays className="text-amber-500 ml-2" size={20} />
                                <select value={selectedWeek} onChange={(e) => setSelectedWeek(Number(e.target.value))} className="w-full bg-transparent font-bold text-amber-900 text-sm focus:outline-none">
                                    {WEEKS_LIST.map((week) => (<option key={week.id} value={week.id}>{week.range}</option>))}
                                </select>
                            </div>
                        </div>
                        {getClassStats().length === 0 ? (
                        <div className="text-center py-16 bg-white rounded-3xl border-2 border-dashed border-slate-200 opacity-70"><p className="text-slate-400 font-medium">Tiada data untuk dianalisis bagi minggu ini.</p></div>
                        ) : (
                        <div className="bg-white rounded-2xl shadow-lg shadow-slate-200 border border-slate-100 overflow-hidden">
                            <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider font-bold"><tr><th className="px-5 py-4 pl-8">Kelas</th><th className="px-5 py-4 text-center">Bil. Masuk</th></tr></thead>
                            <tbody className="divide-y divide-slate-100">
                                {getClassStats().map((stat, idx) => (
                                <tr key={idx} className="hover:bg-amber-50/30 transition-colors">
                                    <td className="px-5 py-4 pl-8"><span className="font-bold text-slate-700 block text-base">{stat.name}</span></td>
                                    <td className="px-5 py-4 text-center"><span className="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-400 text-white rounded-xl font-black shadow-md shadow-orange-100 text-lg">{stat.totalEntries}</span></td>
                                </tr>
                                ))}
                            </tbody>
                            </table>
                        </div>
                        )}
                    </motion.div>
                    )}

                    {activeTab === 'admin' && (
                    <motion.div key="admin" variants={tabVariants} initial="hidden" animate="visible" exit="exit" className="space-y-6">
                        {!isAdmin ? (
                            <div className="flex flex-col items-center justify-center py-10">
                                <div className="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 text-center w-full max-w-sm">
                                    <div className="inline-flex items-center justify-center w-16 h-16 bg-slate-100 text-slate-600 rounded-full mb-4"><Lock size={32} /></div>
                                    <h3 className="text-xl font-bold text-slate-800 mb-2">Akses Admin</h3>
                                    <p className="text-slate-500 text-sm mb-6">Masukkan kata laluan untuk mengakses panel ini.</p>
                                    <form onSubmit={handleAdminLogin} className="space-y-4">
                                        <input 
                                            type="password" 
                                            value={adminPass} 
                                            onChange={(e) => setAdminPass(e.target.value)} 
                                            placeholder="Kata laluan" 
                                            className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl text-center font-bold focus:ring-2 focus:ring-slate-400 focus:outline-none"
                                        />
                                        <button type="submit" className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition-all">Log Masuk</button>
                                        <button type="button" onClick={() => setActiveTab('entry')} className="w-full py-2 text-slate-400 font-medium hover:text-slate-600 text-xs">Batal</button>
                                    </form>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-8">
                                <div className="no-print bg-slate-800 p-6 rounded-3xl text-white shadow-lg relative overflow-hidden">
                                    <div className="relative z-10 flex justify-between items-center">
                                        <div><h3 className="text-xl font-bold">Panel Admin</h3><p className="text-slate-400 text-sm">Pengurusan Rekod & Cetakan</p></div>
                                        <button onClick={handleAdminLogout} className="bg-red-500/20 text-red-100 hover:bg-red-600 hover:text-white p-2 px-3 rounded-xl flex items-center gap-2 text-xs font-bold transition-all"><LogOut size={16} /> Keluar</button>
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <h4 className="no-print text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><Printer size={18} /> Cetakan Jadual Kelas</h4>
                                    
                                    <div className="no-print flex flex-col gap-3 mb-4">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-xs text-slate-400 font-bold uppercase mb-1 block">Minggu</label>
                                                <select value={adminReportWeek} onChange={(e) => setAdminReportWeek(Number(e.target.value))} className="p-2 border border-slate-300 rounded-lg text-sm bg-white font-bold text-slate-700 focus:outline-none w-full">
                                                    {WEEKS_LIST.map((week) => (<option key={week.id} value={week.id}>{week.label} ({week.range})</option>))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-xs text-slate-400 font-bold uppercase mb-1 block">Kelas</label>
                                                <select value={adminReportClass} onChange={(e) => setAdminReportClass(e.target.value)} className="p-2 border border-slate-300 rounded-lg text-sm bg-white font-bold text-slate-700 focus:outline-none w-full">
                                                    <option value="all">Semua Kelas (Banyak Muka Surat)</option>
                                                    {KELAS_LIST.map((kelas) => (<option key={kelas} value={kelas}>{kelas}</option>))}
                                                </select>
                                            </div>
                                        </div>
                                        <button onClick={handlePrint} className="bg-indigo-600 text-white px-4 py-3 rounded-xl font-bold text-sm hover:bg-indigo-700 flex items-center justify-center gap-2 w-full mt-2"><Printer size={16} /> Cetak Jadual Kelas</button>
                                    </div>

                                    {/* JADUAL CETAKAN MASA 1-12 */}
                                    <div id="printable-report" className="hidden">
                                        {classesToPrint.map((className, idx) => {
                                            const tableData = getTableDataForClass(className);
                                            if (!tableData) return null;

                                            return (
                                                <div key={className} className="print-page-break">
                                                    <div className="text-center mb-4">
                                                        <h1 className="text-lg font-bold uppercase mb-1">SK Simpang Empat - Laporan e-Rekod MMI</h1>
                                                        <h2 className="text-base font-bold">Jadual Kehadiran: {className}</h2>
                                                        <p className="text-xs">Minggu: {tableData.weekLabel} ({tableData.range})</p>
                                                    </div>
                                                    
                                                    <table className="w-full border-collapse border border-slate-400 text-xs">
                                                        <thead>
                                                            <tr className="bg-slate-100">
                                                                <th className="border border-slate-400 p-1 w-24">Hari / Masa</th>
                                                                {MASA_LIST.map(m => (
                                                                    <th key={m} className="border border-slate-400 p-1">{m}</th>
                                                                ))}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {tableData.days.map((dayStr, dIdx) => {
                                                                const dayName = ['Ahad', 'Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu'][new Date(dayStr.split('/').reverse().join('-')).getDay()];
                                                                return (
                                                                    <tr key={dIdx}>
                                                                        <td className="border border-slate-400 p-1 font-bold">
                                                                            {dayName}
                                                                            <div className="text-[9px] font-normal mt-1">{dayStr}</div>
                                                                        </td>
                                                                        {MASA_LIST.map(m => {
                                                                            const cellRecord = getTeacherForCell(dayStr, m, className);
                                                                            return (
                                                                                <td key={m} className="border border-slate-400 p-1 h-12">
                                                                                    {cellRecord ? (
                                                                                        <div className="flex flex-col items-center justify-center h-full">
                                                                                            <span className="font-bold text-[9px] leading-tight">{cellRecord.teacherName}</span>
                                                                                            <span className="text-[8px] text-slate-600 leading-tight italic">{cellRecord.subject}</span>
                                                                                        </div>
                                                                                    ) : ''}
                                                                                </td>
                                                                            );
                                                                        })}
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    <div className="mt-2 text-[9px] text-right text-slate-500">Dicetak pada: {new Date().toLocaleString('ms-MY')}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    <div className="no-print mt-4 p-4 bg-slate-50 rounded-xl text-center text-xs text-slate-500 border border-slate-200">
                                        Paparan jadual penuh mengikut kelas akan kelihatan apabila anda menekan butang cetak.
                                    </div>
                                </div>

                                <div className="no-print bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <label className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3 block">Pilih Tarikh untuk Uruskan Laporan</label>
                                    <input type="date" value={adminDate} onChange={(e) => setAdminDate(e.target.value)} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 focus:outline-none"/>
                                </div>

                                <div className="no-print">
                                    <h4 className="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2"><ClipboardList size={16} /> Senarai Rekod ({new Date(adminDate).toLocaleDateString('ms-MY')})</h4>
                                    {adminRecords.length === 0 ? (
                                        <div className="text-center py-10 bg-white rounded-2xl border-2 border-dashed border-slate-200 text-slate-400 text-sm">Tiada rekod pada tarikh ini.</div>
                                    ) : (
                                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden divide-y divide-slate-100">
                                            {adminRecords.map((record) => (
                                                <div key={record.id} className="p-4 flex items-center justify-between hover:bg-slate-50">
                                                    <div><p className="font-bold text-sm text-slate-800">{record.teacherName}</p><p className="text-xs text-slate-500">{record.className}  {record.subject}  Masa {record.period}</p></div>
                                                    <button onClick={() => handleDelete(record.id)} className="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100 transition-colors" title="Padam"><Trash2 size={16} /></button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="no-print bg-white p-6 rounded-2xl shadow-sm border-t-4 border-indigo-500">
                                    <h4 className="text-sm font-bold text-indigo-600 mb-4 flex items-center gap-2"><PlusCircle size={18} /> Tambah Rekod Manual (Backdate)</h4>
                                    <p className="text-xs text-slate-400 mb-4">Rekod akan dimasukkan untuk tarikh: <strong>{new Date(adminDate).toLocaleDateString('ms-MY')}</strong></p>
                                    <div className="space-y-4">
                                        <input type="text" name="teacherName" value={adminFormData.teacherName} onChange={handleAdminInputChange} placeholder="Nama Guru" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium"/>
                                        <div className="grid grid-cols-2 gap-3">
                                            <select name="selectedClass" value={adminFormData.selectedClass} onChange={handleAdminInputChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                                                <option value="">Pilih Kelas</option>
                                                {KELAS_LIST.map(k => <option key={k} value={k}>{k}</option>)}
                                            </select>
                                            <select name="selectedPeriod" value={adminFormData.selectedPeriod} onChange={handleAdminInputChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                                                <option value="">Pilih Masa</option>
                                                {MASA_LIST.map(m => <option key={m} value={m}>{m}</option>)}
                                            </select>
                                        </div>
                                        <select name="selectedSubject" value={adminFormData.selectedSubject} onChange={handleAdminInputChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                                            <option value="">Pilih Subjek</option>
                                            {SUBJEK_LIST.map(s => <option key={s} value={s}>{s}</option>)}
                                        </select>
                                        <button onClick={handleAdminSubmit} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all text-sm">Simpan Rekod Manual</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </motion.div>
                    )}

                    </AnimatePresence>

                </main>
                
                <footer className="no-print text-center p-8 text-indigo-300 text-[10px] font-medium tracking-wide">
                    <p> 2026 SKSE</p>
                    <p className="opacity-50 mt-1">SePaT </p>
                </footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
